<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Penyuluh Pertanian Digital - Chatbot berbasis RAG untuk membantu petani Indonesia">
    <meta name="theme-color" content="#2E7D32">
    <title>Penyuluh Pertanian Digital</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="{{ url_for('static', filename='style.css') }}" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/marked/marked.min.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" as="script">
    
    <!-- Load CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- Load JavaScript with defer for better performance -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" defer></script>
    
    <!-- Service Worker for caching -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
    </script>
</head>
<body>
    <h1>Selamat datang, {{ user }}!</h1>

    <!-- Tombol ke Halaman Profil -->
    <a href="{{ url_for('profil') }}">
        <button>Profil Saya</button>
    </a>
    
    <div id="chat-window">
        <div id="chat-header">
            <h1>Penyuluh Pertanian Digital ðŸŒ±</h1>
            <p>Chatbot berbasis RAG dengan data paper pertanian Indonesia.</p>

            <!-- âœ… Tombol Ajukan Pengaduan -->
            <a href="{{ url_for('form_pengaduan') }}" class="btn-pengaduan">ðŸ“¢ Ajukan Pengaduan</a>

            <!-- âœ… Tombol Riwayat Pengaduan -->
            <a href="{{ url_for('riwayat_pengaduan') }}" class="btn-riwayat-pengaduan">ðŸ“‘ Lihat Riwayat Pengaduan</a>
        </div>
        <div id="chat-messages">
            <div class="message bot-message">
                <p>Halo! Saya siap membantu Anda. Apa yang ingin Anda ketahui?</p>
            </div>
        </div>
        <div id="chat-input-container">
            <form id="chat-form">
                <input type="text" id="user-input" placeholder="Ketik pertanyaan Anda di sini..." autocomplete="off" autofocus>
                <button type="submit">Kirim</button>
            </form>
        </div>
    </div>

    <script>
        // Optimized JavaScript with better performance
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        let conversationHistory = [];
        let isProcessing = false; // Prevent multiple simultaneous requests

        // Debounce function for better performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Optimized message adding function
        function addMessage(text, sender, isLoading = false, sources = []) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);

            if (isLoading) {
                messageElement.innerHTML = `<p>...</p>`;
                messageElement.classList.add('loading');
            } else if (sender === 'bot') {
                // Use marked and DOMPurify for safe HTML rendering
                if (window.marked && window.DOMPurify) {
                    const rawHtml = marked.parse(text);
                    const sanitizedHtml = DOMPurify.sanitize(rawHtml);
                    messageElement.innerHTML = sanitizedHtml;
                } else {
                    // Fallback for when libraries aren't loaded yet
                    messageElement.textContent = text;
                }

                // Add sources if available
                if (sources && sources.length > 0) {
                    const sourceContainer = document.createElement('div');
                    sourceContainer.className = 'source-container';
                    sourceContainer.innerHTML = `
                        <h4>ðŸ“„ Sumber Referensi:</h4>
                        <ul>
                            ${sources.map(source => `<li><strong>${source.title}</strong></li>`).join('')}
                        </ul>
                    `;
                    messageElement.appendChild(sourceContainer);
                }
            } else {
                messageElement.textContent = text;
            }

            chatMessages.appendChild(messageElement);
            
            // Smooth scroll to bottom
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });

            return messageElement;
        }

        // Optimized form submission with debouncing
        const debouncedSubmit = debounce(async function(userMessage) {
            if (isProcessing) return;
            isProcessing = true;

            const loadingIndicator = addMessage('...', 'bot', true);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ 
                        message: userMessage, 
                        history: conversationHistory 
                    })
                });

                loadingIndicator.remove();

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const botReply = data.reply;
                const sources = data.sources;
                
                addMessage(botReply, 'bot', false, sources);
                conversationHistory.push({ user: userMessage, bot: botReply });

            } catch (error) {
                console.error('Chat error:', error);
                addMessage('Maaf, terjadi error saat menghubungi server. Silakan coba lagi.', 'bot');
            } finally {
                isProcessing = false;
            }
        }, 300);

        // Form submission handler
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const userMessage = userInput.value.trim();
            if (!userMessage || isProcessing) return;

            addMessage(userMessage, 'user');
            userInput.value = '';
            
            debouncedSubmit(userMessage);
        });

        // Enter key handler
        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Auto-resize input for better UX
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Focus management for better accessibility
        userInput.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });

        userInput.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`Page load time: ${loadTime}ms`);
            });
        }

        // Error handling for better debugging
        window.addEventListener('error', function(event) {
            console.error('JavaScript error:', event.error);
        });

        // Unhandled promise rejection handling
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>

    <div id="navbar">
        <span>ðŸ‘¤ {{ user }}</span>
        <a href="{{ url_for('logout') }}" class="logout-button">ðŸšª Logout</a>
    </div>
</body>
</html>
